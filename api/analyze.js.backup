import { spawn } from 'child_process'
import path from 'path'

export default async function handler(req, res) {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS')
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type')

  if (req.method === 'OPTIONS') {
    res.status(200).end()
    return
  }

  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' })
    return
  }

  try {
    // 一時的にモックデータを返す（APIの動作確認用）
    const mockData = {
      improved_queries: [
        {
          query: "沖縄 レンタカー",
          url: "https://www.tabirai.net/car/okinawa/",
          directory: "car",
          past_position: 15,
          current_position: 8,
          change: 7,
          clicks_change: 125,
          status: "improved",
          past_clicks: 250,
          current_clicks: 375,
          past_impressions: 5000,
          current_impressions: 6200
        },
        {
          query: "北海道 観光",
          url: "https://www.tabirai.net/sightseeing/hokkaido/",
          directory: "sightseeing",
          past_position: null,
          current_position: 12,
          change: "new",
          clicks_change: 80,
          status: "new",
          past_clicks: 0,
          current_clicks: 80,
          past_impressions: 0,
          current_impressions: 1800
        }
      ],
      declined_queries: [
        {
          query: "古いキーワード",
          url: "https://www.tabirai.net/old-page/",
          directory: "old",
          past_position: 5,
          current_position: 18,
          change: -13,
          clicks_change: -50,
          status: "declined",
          past_clicks: 150,
          current_clicks: 100,
          past_impressions: 3000,
          current_impressions: 2200
        }
      ],
      directory_analysis: {
        "car": 1256,
        "sightseeing": 789,
        "hotel": 445,
        "flight": 267,
        "bus": 123
      },
      summary: {
        improved_total: 2,
        declined_total: 1,
        new_queries: 1,
        disappeared_queries: 0,
        clicks_past: 400,
        clicks_current: 555,
        clicks_change: 155,
        impressions_past: 8000,
        impressions_current: 10200,
        impressions_change: 2200,
        filtered_queries: 3
      },
      filters_applied: {
        url_filter: req.body.url_filter || '',
        query_filter: req.body.query_filter || ''
      }
    }

    // 少し遅延を入れてリアルなAPI感を演出
    await new Promise(resolve => setTimeout(resolve, 2000))

    res.status(200).json(mockData)

  } catch (error) {
    console.error('API Error:', error)
    res.status(500).json({ error: error.message })
  }
}